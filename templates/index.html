{% extends "base.html" %}

{% block title %}Predict Churn Risk - ChurnGuard{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50">
    <!-- Hero Section -->
    <section class="bg-gradient-to-r from-blue-600 to-purple-600 text-white py-16 px-4 sm:px-6 lg:px-8">
        <div class="max-w-4xl mx-auto text-center">
            <h1 class="text-5xl md:text-6xl font-bold mb-6">
                Predict Customer
                <span class="text-yellow-300">
                    Churn Risk
                </span>
            </h1>
            <p class="text-xl text-blue-100 max-w-3xl mx-auto leading-relaxed">
                Analyze individual customers or process bulk data to identify at-risk customers
                and take proactive retention measures.
            </p>
        </div>
    </section>

    <!-- Main Content -->
    <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-16">
        <!-- Tabs -->
        <div class="flex justify-center mb-12 space-x-4">
            <button class="tab-btn bg-white text-gray-700 px-8 py-4 rounded-full font-semibold text-lg transition-all duration-300 shadow-lg hover:shadow-xl hover:-translate-y-1 border-2 border-gray-200" onclick="switchTab('single')">Single Customer</button>
            <button class="tab-btn bg-gray-100 text-gray-500 px-8 py-4 rounded-full font-semibold text-lg transition-all duration-300 shadow-md hover:shadow-lg hover:-translate-y-1" onclick="switchTab('batch')">Batch Analysis</button>
        </div>

        <!-- Single Customer Prediction -->
        <div id="single" class="tab-content block">
            <div class="bg-white rounded-2xl p-8 shadow-xl border border-gray-200">
                <h2 class="text-3xl font-bold mb-8 text-gray-800 text-center">Customer Information</h2>
                <form id="customerForm" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label for="tenure" class="block font-semibold text-gray-700">Tenure (months)</label>
                            <input type="number" id="tenure" name="Tenure" min="0" max="61" step="1" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-lg transition-all duration-300 bg-white text-gray-800 placeholder-gray-400 focus:border-blue-500 focus:ring-4 focus:ring-blue-100">
                        </div>
                        <div class="space-y-2">
                            <label for="satisfaction" class="block font-semibold text-gray-700">Satisfaction Score (1-5)</label>
                            <select id="satisfaction" name="SatisfactionScore" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-lg transition-all duration-300 bg-white text-gray-800 focus:border-blue-500 focus:ring-4 focus:ring-blue-100">
                                <option value="" class="bg-gray-50">Select...</option>
                                <option value="1" class="bg-gray-50">1 - Very Unsatisfied</option>
                                <option value="2" class="bg-gray-50">2 - Unsatisfied</option>
                                <option value="3" class="bg-gray-50">3 - Neutral</option>
                                <option value="4" class="bg-gray-50">4 - Satisfied</option>
                                <option value="5" class="bg-gray-50">5 - Very Satisfied</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label for="orders" class="block font-semibold text-gray-700">Number of Orders</label>
                            <input type="number" id="orders" name="OrderCount" min="0" max="16" step="1" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-lg transition-all duration-300 bg-white text-gray-800 placeholder-gray-400 focus:border-blue-500 focus:ring-4 focus:ring-blue-100">
                        </div>
                        <div class="space-y-2">
                            <label for="appHours" class="block font-semibold text-gray-700">App Usage (hours/day)</label>
                            <input type="number" id="appHours" name="HourSpendOnApp" min="0" max="5" step="0.1" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-lg transition-all duration-300 bg-white text-gray-800 placeholder-gray-400 focus:border-blue-500 focus:ring-4 focus:ring-blue-100">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label for="daysSince" class="block font-semibold text-gray-700">Days Since Last Order</label>
                            <input type="number" id="daysSince" name="DaySinceLastOrder" min="0" max="46" step="1" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-lg transition-all duration-300 bg-white text-gray-800 placeholder-gray-400 focus:border-blue-500 focus:ring-4 focus:ring-blue-100">
                        </div>
                        <div class="space-y-2">
                            <label for="warehouse" class="block font-semibold text-gray-700">Warehouse Distance (km)</label>
                            <input type="number" id="warehouse" name="WarehouseToHome" min="5" max="127" step="1" required class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-lg transition-all duration-300 bg-white text-gray-800 placeholder-gray-400 focus:border-blue-500 focus:ring-4 focus:ring-blue-100">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label for="devices" class="block font-semibold text-gray-700">Registered Devices</label>
                            <input type="number" id="devices" name="NumberOfDeviceRegistered" min="1" max="6" step="1" value="1" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-lg transition-all duration-300 bg-white text-gray-800 placeholder-gray-400 focus:border-blue-500 focus:ring-4 focus:ring-blue-100">
                        </div>
                        <div class="space-y-2">
                            <label for="addresses" class="block font-semibold text-gray-700">Number of Addresses</label>
                            <input type="number" id="addresses" name="NumberOfAddress" min="1" max="22" step="1" value="1" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-lg transition-all duration-300 bg-white text-gray-800 placeholder-gray-400 focus:border-blue-500 focus:ring-4 focus:ring-blue-100">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label for="orderHike" class="block font-semibold text-gray-700">Order Amount Growth (%)</label>
                            <input type="number" id="orderHike" name="OrderAmountHikeFromlastYear" min="0" max="26" step="1" value="0" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-lg transition-all duration-300 bg-white text-gray-800 placeholder-gray-400 focus:border-blue-500 focus:ring-4 focus:ring-blue-100">
                        </div>
                        <div class="space-y-2">
                            <label for="coupons" class="block font-semibold text-gray-700">Coupons Used</label>
                            <input type="number" id="coupons" name="CouponUsed" min="0" max="16" step="1" value="0" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-lg transition-all duration-300 bg-white text-gray-800 placeholder-gray-400 focus:border-blue-500 focus:ring-4 focus:ring-blue-100">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label for="cashback" class="block font-semibold text-gray-700">Cashback Amount</label>
                            <input type="number" id="cashback" name="CashbackAmount" min="0" max="324" step="1" value="0" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-lg transition-all duration-300 bg-white text-gray-800 placeholder-gray-400 focus:border-blue-500 focus:ring-4 focus:ring-blue-100">
                        </div>
                        <div class="space-y-2">
                            <label for="complain" class="block font-semibold text-gray-700">Has Complained?</label>
                            <select id="complain" name="Complain" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-lg transition-all duration-300 bg-white text-gray-800 focus:border-blue-500 focus:ring-4 focus:ring-blue-100">
                                <option value="0" class="bg-gray-50">No</option>
                                <option value="1" class="bg-gray-50">Yes</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label for="loginDevice" class="block font-semibold text-gray-700">Preferred Login Device</label>
                            <select id="loginDevice" name="PreferredLoginDevice" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-lg transition-all duration-300 bg-white text-gray-800 focus:border-blue-500 focus:ring-4 focus:ring-blue-100">
                                <option value="0" class="bg-gray-50">Mobile Phone</option>
                                <option value="1" class="bg-gray-50">Computer</option>
                                <option value="2" class="bg-gray-50">Phone</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label for="cityTier" class="block font-semibold text-gray-700">City Tier</label>
                            <select id="cityTier" name="CityTier" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-lg transition-all duration-300 bg-white text-gray-800 focus:border-blue-500 focus:ring-4 focus:ring-blue-100">
                                <option value="1" class="bg-gray-50">Tier 1 (Metro)</option>
                                <option value="2" class="bg-gray-50">Tier 2</option>
                                <option value="3" class="bg-gray-50">Tier 3</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label for="paymentMode" class="block font-semibold text-gray-700">Preferred Payment</label>
                            <select id="paymentMode" name="PreferredPaymentMode" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-lg transition-all duration-300 bg-white text-gray-800 focus:border-blue-500 focus:ring-4 focus:ring-blue-100">
                                <option value="0" class="bg-gray-50">Debit Card</option>
                                <option value="1" class="bg-gray-50">UPI</option>
                                <option value="2" class="bg-gray-50">Credit Card</option>
                                <option value="3" class="bg-gray-50">Cash on Delivery</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label for="gender" class="block font-semibold text-gray-700">Gender</label>
                            <select id="gender" name="Gender" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-lg transition-all duration-300 bg-white text-gray-800 focus:border-blue-500 focus:ring-4 focus:ring-blue-100">
                                <option value="0" class="bg-gray-50">Female</option>
                                <option value="1" class="bg-gray-50">Male</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label for="marital" class="block font-semibold text-gray-700">Marital Status</label>
                            <select id="marital" name="MaritalStatus" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-lg transition-all duration-300 bg-white text-gray-800 focus:border-blue-500 focus:ring-4 focus:ring-blue-100">
                                <option value="0" class="bg-gray-50">Single</option>
                                <option value="1" class="bg-gray-50">Married</option>
                            </select>
                        </div>
                        <div class="space-y-2">
                            <label for="category" class="block font-semibold text-gray-700">Preferred Category</label>
                            <select id="category" name="PreferedOrderCat" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl text-lg transition-all duration-300 bg-white text-gray-800 focus:border-blue-500 focus:ring-4 focus:ring-blue-100">
                                <option value="0" class="bg-gray-50">Laptop & Accessory</option>
                                <option value="1" class="bg-gray-50">Mobile Phone</option>
                                <option value="2" class="bg-gray-50">Others</option>
                                <option value="3" class="bg-gray-50">Fashion</option>
                                <option value="4" class="bg-gray-50">Grocery</option>
                                <option value="5" class="bg-gray-50">Books</option>
                            </select>
                        </div>
                    </div>

                    <div class="flex justify-center space-x-4 pt-6">
                        <button type="button" class="bg-gradient-to-r from-green-500 to-teal-600 text-white px-8 py-4 rounded-full font-bold text-lg transition-all duration-300 shadow-lg hover:shadow-xl hover:-translate-y-1" onclick="loadSampleData()">Load Sample Data</button>
                        <button type="submit" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-10 py-4 rounded-full font-bold text-lg transition-all duration-300 shadow-lg hover:shadow-xl hover:-translate-y-1 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none" id="predictBtn">
                            <span id="predictText">Predict Churn Risk</span>
                        </button>
                    </div>
                </form>

                <div id="singleResult" class="mt-8"></div>
            </div>
        </div>

        <!-- Batch Analysis -->
        <div id="batch" class="tab-content hidden">
            <div class="bg-white rounded-2xl p-8 shadow-xl border border-gray-200">
                <h2 class="text-3xl font-bold mb-8 text-gray-800 text-center">Batch Customer Analysis</h2>
                <p class="mb-8 text-gray-600 text-center text-lg">Upload a CSV file or paste customer data for bulk analysis</p>

                <div class="border-2 border-dashed border-blue-300 rounded-2xl p-12 text-center bg-blue-50 cursor-pointer transition-all duration-300 hover:bg-blue-100 hover:border-blue-400 hover:scale-105 mb-8" id="fileUpload">
                    <div class="text-6xl mb-4 text-blue-400">📁</div>
                    <h3 class="text-xl font-semibold mb-2 text-gray-700">Drop CSV file here or click to browse</h3>
                    <p class="text-blue-600">Supports CSV files with customer data</p>
                    <input type="file" id="csvFile" accept=".csv" class="hidden">
                </div>

                <div class="space-y-4 mb-8">
                    <label for="csvData" class="block font-semibold text-gray-700 text-lg">Or paste CSV data:</label>
                    <textarea id="csvData" class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl font-mono text-sm min-h-48 bg-white text-gray-800 placeholder-gray-400 focus:border-blue-500 focus:ring-4 focus:ring-blue-100" placeholder="Paste your CSV data here...

Example:
Tenure,SatisfactionScore,OrderCount,HourSpendOnApp,DaySinceLastOrder,WarehouseToHome,Complain
12,3,6,2.0,8,15,0
2,2,1,0.5,30,25,1"></textarea>
                </div>

                <div class="flex justify-center">
                    <button type="button" class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-10 py-4 rounded-full font-bold text-lg transition-all duration-300 shadow-lg hover:shadow-xl hover:-translate-y-1 disabled:bg-gray-400 disabled:cursor-not-allowed disabled:transform-none disabled:shadow-none" id="batchPredictBtn" onclick="processBatchData()">
                        <span id="batchPredictText">Analyze Batch Data</span>
                    </button>
                </div>

                <div id="batchResult" class="mt-8"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
<script>
    // API Configuration
    const API_BASE_URL = 'https://churn-prediction-3f9f.onrender.com/api';

    // Tab switching
    function switchTab(tabName) {
        // Remove active class from all tabs and content
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.classList.remove('bg-white', 'text-gray-800', '-translate-y-0.5', 'border-gray-200');
            btn.classList.add('bg-gray-100', 'text-gray-500');
        });
        document.querySelectorAll('.tab-content').forEach(content => content.classList.add('hidden'));

        // Add active class to selected tab and content
        event.target.classList.remove('bg-gray-100', 'text-gray-500');
        event.target.classList.add('bg-white', 'text-gray-800', '-translate-y-0.5', 'border-gray-200');
        document.getElementById(tabName).classList.remove('hidden');
        document.getElementById(tabName).classList.add('block');
    }

    // File upload handling
    const fileUpload = document.getElementById('fileUpload');
    const csvFile = document.getElementById('csvFile');
    const csvData = document.getElementById('csvData');

    fileUpload.addEventListener('click', () => csvFile.click());
    fileUpload.addEventListener('dragover', (e) => {
        e.preventDefault();
        fileUpload.classList.add('border-blue-500', 'bg-opacity-10');
    });
    fileUpload.addEventListener('dragleave', () => {
        fileUpload.classList.remove('border-blue-500', 'bg-opacity-10');
    });
    fileUpload.addEventListener('drop', (e) => {
        e.preventDefault();
        fileUpload.classList.remove('border-blue-500', 'bg-opacity-10');
        const files = e.dataTransfer.files;
        if (files.length > 0 && files[0].type === 'text/csv') {
            handleFileUpload(files[0]);
        }
    });

    csvFile.addEventListener('change', (e) => {
        if (e.target.files.length > 0) {
            handleFileUpload(e.target.files[0]);
        }
    });

    function handleFileUpload(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            csvData.value = e.target.result;
        };
        reader.readAsText(file);
    }

    // Single customer prediction
    document.getElementById('customerForm').addEventListener('submit', async (e) => {
        e.preventDefault();

        const formData = new FormData(e.target);
        const customerData = {};

        // Convert form data to object with proper types
        for (let [key, value] of formData.entries()) {
            customerData[key] = isNaN(value) ? value : Number(value);
        }

        await makePrediction(customerData);
    });

    async function makePrediction(data) {
        const predictBtn = document.getElementById('predictBtn');
        const predictText = document.getElementById('predictText');
        const resultDiv = document.getElementById('singleResult');

        // Show loading state
        predictBtn.disabled = true;
        predictText.innerHTML = '<span class="inline-block w-5 h-5 border-3 border-white border-t-transparent rounded-full animate-spin mr-2"></span>Analyzing...';
        resultDiv.innerHTML = '';

        try {
            const response = await fetch(`${API_BASE_URL}/predict`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            });

            const result = await response.json();

            if (result.success) {
                displaySingleResult(result);
            } else {
                displayError(result.error);
            }
        } catch (error) {
            displayError('Network error: ' + error.message);
        } finally {
            predictBtn.disabled = false;
            predictText.innerHTML = 'Predict Churn Risk';
        }
    }

    function displaySingleResult(result) {
        const resultDiv = document.getElementById('singleResult');

        // Create probability chart data
        const probabilityData = {
            labels: ['Retention Probability', 'Churn Probability'],
            datasets: [{
                data: [result.chart_data.probability_breakdown.retention, result.chart_data.probability_breakdown.churn],
                backgroundColor: ['#10B981', '#EF4444'],
                borderWidth: 0
            }]
        };

        // Create risk factors chart data
        const riskFactorsData = {
            labels: Object.keys(result.risk_factors),
            datasets: [{
                label: 'Risk Score',
                data: Object.values(result.risk_factors).map(f => f.score),
                backgroundColor: [
                    '#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'
                ],
                borderWidth: 0
            }]
        };

        // Create customer metrics chart data
        const metricsData = {
            labels: ['Satisfaction', 'Engagement', 'Tenure', 'Order Frequency'],
            datasets: [{
                label: 'Score (%)',
                data: [
                    result.chart_data.customer_metrics.satisfaction,
                    result.chart_data.customer_metrics.engagement,
                    result.chart_data.customer_metrics.tenure,
                    result.chart_data.customer_metrics.order_frequency
                ],
                backgroundColor: '#3B82F6',
                borderColor: '#2563EB',
                borderWidth: 2,
                fill: false,
                tension: 0.4
            }]
        };

        const riskClass = result.risk_level.toLowerCase();
        const bgClasses = {
            high: 'bg-gradient-to-r from-red-400 to-red-600',
            medium: 'bg-gradient-to-r from-yellow-400 to-orange-500',
            low: 'bg-gradient-to-r from-green-400 to-green-600'
        };

        resultDiv.innerHTML = `
            <div class="space-y-8">
                <!-- Main Risk Assessment Card -->
                <div class="p-8 rounded-2xl text-white ${bgClasses[riskClass]} shadow-xl">
                    <div class="flex items-center justify-between mb-6">
                        <div>
                            <h3 class="text-3xl font-bold mb-2">${result.risk_level} Risk Customer</h3>
                            <p class="text-xl opacity-90">${result.customer_profile.behavior_summary}</p>
                        </div>
                        <div class="text-right">
                            <div class="text-4xl font-bold">${result.risk_score}/10</div>
                            <div class="text-sm opacity-80">Risk Score</div>
                        </div>
                    </div>

                    <p class="text-lg leading-relaxed mb-6">${result.recommendation}</p>

                    <!-- Key Metrics Grid -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-white bg-opacity-20 p-4 rounded-xl text-center">
                            <div class="text-2xl font-bold">${result.chart_data.probability_breakdown.churn}%</div>
                            <div class="text-sm opacity-80">Churn Risk</div>
                        </div>
                        <div class="bg-white bg-opacity-20 p-4 rounded-xl text-center">
                            <div class="text-2xl font-bold">${result.chart_data.probability_breakdown.retention}%</div>
                            <div class="text-sm opacity-80">Retention</div>
                        </div>
                        <div class="bg-white bg-opacity-20 p-4 rounded-xl text-center">
                            <div class="text-2xl font-bold">${result.confidence}</div>
                            <div class="text-sm opacity-80">Confidence</div>
                        </div>
                        <div class="bg-white bg-opacity-20 p-4 rounded-xl text-center">
                            <div class="text-2xl font-bold">${result.urgency_level}</div>
                            <div class="text-sm opacity-80">Urgency</div>
                        </div>
                    </div>

                    <div class="bg-white bg-opacity-20 p-4 rounded-xl">
                        <div class="text-sm opacity-80 mb-1">Action Timeline</div>
                        <div class="text-lg font-semibold">${result.time_to_action}</div>
                    </div>
                </div>

                <!-- Charts Row -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Probability Breakdown Chart -->
                    <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200">
                        <h4 class="text-xl font-bold mb-4 text-gray-800">Churn vs Retention Probability</h4>
                        <div class="relative" style="height: 300px;">
                            <canvas id="probabilityChart" style="width: 100%; height: 100%;"></canvas>
                        </div>
                    </div>

                    <!-- Risk Factors Chart -->
                    <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200">
                        <h4 class="text-xl font-bold mb-4 text-gray-800">Risk Factor Analysis</h4>
                        <div class="relative" style="height: 300px;">
                            <canvas id="riskFactorsChart" style="width: 100%; height: 100%;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Customer Metrics Chart -->
                <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200">
                    <h4 class="text-xl font-bold mb-4 text-gray-800">Customer Behavior Metrics</h4>
                    <div class="relative" style="height: 250px;">
                        <canvas id="metricsChart" style="width: 100%; height: 100%;"></canvas>
                    </div>
                </div>

                <!-- Detailed Analysis Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <!-- Customer Profile -->
                    <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200">
                        <h4 class="text-xl font-bold mb-4 text-gray-800">Customer Profile</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Customer Type:</span>
                                <span class="font-semibold text-gray-800">${result.customer_profile.customer_type}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Loyalty Status:</span>
                                <span class="font-semibold text-gray-800">${result.customer_profile.loyalty_status}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Engagement:</span>
                                <span class="font-semibold text-gray-800">${result.customer_profile.engagement_level}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Satisfaction:</span>
                                <span class="font-semibold text-gray-800">${result.customer_profile.satisfaction_status}</span>
                            </div>
                            <hr class="my-3">
                            <div class="grid grid-cols-2 gap-4 text-sm">
                                <div>
                                    <div class="text-gray-600">Tenure</div>
                                    <div class="font-semibold text-gray-800">${result.customer_profile.key_metrics.tenure_months} months</div>
                                </div>
                                <div>
                                    <div class="text-gray-600">Total Orders</div>
                                    <div class="font-semibold text-gray-800">${result.customer_profile.key_metrics.total_orders}</div>
                                </div>
                                <div>
                                    <div class="text-gray-600">App Usage</div>
                                    <div class="font-semibold text-gray-800">${result.customer_profile.key_metrics.avg_app_usage} hrs/day</div>
                                </div>
                                <div>
                                    <div class="text-gray-600">Days Since Order</div>
                                    <div class="font-semibold text-gray-800">${result.customer_profile.key_metrics.days_since_last_order}</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- CLV Estimation -->
                    <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200">
                        <h4 class="text-xl font-bold mb-4 text-gray-800">Customer Lifetime Value</h4>
                        <div class="space-y-3">
                            <div class="flex justify-between">
                                <span class="text-gray-600">Current Annual Value:</span>
                                <span class="font-semibold text-green-600">$${result.clv_estimation.current_annual_value}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Projected Lifetime:</span>
                                <span class="font-semibold text-blue-600">$${result.clv_estimation.projected_lifetime_value}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Potential Loss:</span>
                                <span class="font-semibold text-red-600">$${result.clv_estimation.potential_loss_if_churn}</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">Retention Opportunity:</span>
                                <span class="font-semibold text-purple-600">$${result.clv_estimation.retention_opportunity}</span>
                            </div>
                            <hr class="my-3">
                            <div class="bg-blue-50 p-3 rounded-lg">
                                <div class="text-sm text-gray-600 mb-1">Max Investment for Retention</div>
                                <div class="text-lg font-bold text-blue-600">$${result.clv_estimation.break_even_cost}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Key Insights -->
                <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200">
                    <h4 class="text-xl font-bold mb-4 text-gray-800">Key Insights & Risk Factors</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h5 class="font-semibold text-gray-700 mb-3">Critical Insights</h5>
                            <ul class="space-y-2">
                                ${result.insights.map(insight => `<li class="flex items-start"><span class="text-blue-500 mr-2">•</span><span class="text-gray-700">${insight}</span></li>`).join('')}
                            </ul>
                        </div>
                        <div>
                            <h5 class="font-semibold text-gray-700 mb-3">Risk Factor Details</h5>
                            <div class="space-y-2">
                                ${Object.entries(result.risk_factors).map(([factor, data]) =>
                                    `<div class="flex justify-between items-center">
                                        <span class="text-gray-600">${factor}:</span>
                                        <div class="flex items-center space-x-2">
                                            <div class="w-16 bg-gray-200 rounded-full h-2">
                                                <div class="bg-blue-500 h-2 rounded-full" style="width: ${data.score}%"></div>
                                            </div>
                                            <span class="text-sm font-semibold ${data.level === 'Low' ? 'text-red-500' : data.level === 'Medium' ? 'text-yellow-500' : 'text-green-500'}">${data.score}%</span>
                                        </div>
                                    </div>`
                                ).join('')}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Retention Strategies -->
                <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200">
                    <h4 class="text-xl font-bold mb-4 text-gray-800">Recommended Retention Strategies</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${result.retention_strategies.map(strategy => `
                            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-sm font-semibold ${strategy.priority === 'Immediate' ? 'text-red-600' : strategy.priority === 'Within 48h' ? 'text-orange-600' : 'text-blue-600'}">${strategy.priority}</span>
                                    <span class="text-xs px-2 py-1 rounded-full ${strategy.expected_impact === 'High' ? 'bg-green-100 text-green-800' : strategy.expected_impact === 'Medium' ? 'bg-yellow-100 text-yellow-800' : 'bg-gray-100 text-gray-800'}">${strategy.expected_impact} Impact</span>
                                </div>
                                <h5 class="font-semibold text-gray-800 mb-1">${strategy.action}</h5>
                                <p class="text-sm text-gray-600 mb-2">${strategy.description}</p>
                                <div class="text-xs text-gray-500">Cost: ${strategy.cost}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Action Timeline -->
                <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200">
                    <h4 class="text-xl font-bold mb-4 text-gray-800">Action Timeline</h4>
                    <div class="space-y-4">
                        ${result.action_timeline.map((phase, index) => `
                            <div class="flex items-start space-x-4">
                                <div class="flex-shrink-0 w-8 h-8 bg-blue-500 text-white rounded-full flex items-center justify-center text-sm font-semibold">
                                    ${index + 1}
                                </div>
                                <div class="flex-grow">
                                    <div class="font-semibold text-gray-800">${phase.time}</div>
                                    <ul class="mt-1 text-sm text-gray-600">
                                        ${phase.actions.map(action => `<li class="flex items-center"><span class="w-1 h-1 bg-blue-500 rounded-full mr-2"></span>${action}</li>`).join('')}
                                    </ul>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Comparative Analysis -->
                <div class="bg-white p-6 rounded-2xl shadow-xl border border-gray-200">
                    <h4 class="text-xl font-bold mb-4 text-gray-800">Comparative Analysis</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-gray-700 mb-2">Similar Customers</h5>
                            <p class="text-gray-600 text-sm">${result.comparative_analysis.similar_customers}</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-gray-700 mb-2">Benchmark Performance</h5>
                            <p class="text-gray-600 text-sm">${result.comparative_analysis.benchmark}</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-gray-700 mb-2">Improvement Potential</h5>
                            <p class="text-gray-600 text-sm">${result.comparative_analysis.improvement_potential}</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg">
                            <h5 class="font-semibold text-gray-700 mb-2">Historical Success Rate</h5>
                            <p class="text-gray-600 text-sm font-semibold text-green-600">${result.comparative_analysis.success_rate}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Initialize charts after a short delay to ensure DOM is ready
        console.log('Initializing charts with data:', { probabilityData, riskFactorsData, metricsData });
        setTimeout(() => {
            initializeCharts(probabilityData, riskFactorsData, metricsData);
        }, 100);
    }

    // Batch prediction
    async function processBatchData() {
        const csvDataValue = csvData.value.trim();
        if (!csvDataValue) {
            alert('Please provide CSV data');
            return;
        }

        const batchBtn = document.getElementById('batchPredictBtn');
        const batchText = document.getElementById('batchPredictText');
        const resultDiv = document.getElementById('batchResult');

        batchBtn.disabled = true;
        batchText.innerHTML = '<span class="inline-block w-5 h-5 border-3 border-white border-t-transparent rounded-full animate-spin mr-2"></span>Processing...';
        resultDiv.innerHTML = '';

        try {
            const customers = parseCSV(csvDataValue);

            const response = await fetch(`${API_BASE_URL}/batch_predict`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ customers })
            });

            const result = await response.json();

            if (result.success) {
                displayBatchResults(result);
            } else {
                displayBatchError(result.error);
            }
        } catch (error) {
            displayBatchError('Error processing data: ' + error.message);
        } finally {
            batchBtn.disabled = false;
            batchText.innerHTML = 'Analyze Batch Data';
        }
    }

    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim());
        const customers = [];

        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',');
            const customer = {};

            headers.forEach((header, index) => {
                const value = values[index]?.trim();
                customer[header] = isNaN(value) ? value : Number(value);
            });

            customers.push(customer);
        }

        return customers;
    }

    function displayBatchResults(result) {
        const resultDiv = document.getElementById('batchResult');

        resultDiv.innerHTML = `
            <div class="mt-8">
                <h3 class="text-3xl font-bold mb-6 text-gray-800 text-center">Analysis Complete</h3>
                <p class="text-xl mb-8 text-gray-600 text-center">Analyzed ${result.total_customers} customers</p>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-8 mb-10">
                    <div class="bg-gradient-to-r from-red-400 to-red-600 text-white p-8 rounded-2xl text-center shadow-xl">
                        <h4 class="text-xl opacity-90 mb-4 font-semibold">High Risk</h4>
                        <div class="text-5xl font-bold">${result.risk_summary.High || 0}</div>
                    </div>
                    <div class="bg-gradient-to-r from-yellow-400 to-orange-500 text-white p-8 rounded-2xl text-center shadow-xl">
                        <h4 class="text-xl opacity-90 mb-4 font-semibold">Medium Risk</h4>
                        <div class="text-5xl font-bold">${result.risk_summary.Medium || 0}</div>
                    </div>
                    <div class="bg-gradient-to-r from-green-400 to-green-600 text-white p-8 rounded-2xl text-center shadow-xl">
                        <h4 class="text-xl opacity-90 mb-4 font-semibold">Low Risk</h4>
                        <div class="text-5xl font-bold">${result.risk_summary.Low || 0}</div>
                    </div>
                </div>

                <div class="flex justify-center">
                    <button class="bg-gradient-to-r from-blue-500 to-purple-600 text-white px-10 py-4 rounded-full font-bold text-lg transition-all duration-300 shadow-lg hover:shadow-xl hover:-translate-y-1" onclick="downloadResults('${JSON.stringify(result.results).replace(/'/g, "\\'")}')">
                        Download Detailed Results
                    </button>
                </div>
            </div>
        `;
    }

    function downloadResults(resultsJson) {
        const results = JSON.parse(resultsJson);
        let csvContent = 'Customer_ID,Risk_Level,Churn_Probability,Retention_Probability,Confidence,Recommendation\n';

        results.forEach(result => {
            if (result.success) {
                csvContent += `${result.customer_id},${result.risk_level},${result.churn_probability},${result.retention_probability},${result.confidence},"${result.recommendation}"\n`;
            }
        });

        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'churn_analysis_results.csv';
        a.click();
        window.URL.revokeObjectURL(url);
    }

    function displayError(error) {
        document.getElementById('singleResult').innerHTML = `
            <div class="mt-8 bg-red-50 border border-red-200 text-red-800 p-6 rounded-2xl shadow-lg">
                <strong class="text-xl">Error:</strong> <span class="text-lg ml-2">${error}</span>
            </div>
        `;
    }

    function displayBatchError(error) {
        document.getElementById('batchResult').innerHTML = `
            <div class="mt-8 bg-red-50 border border-red-200 text-red-800 p-6 rounded-2xl shadow-lg">
                <strong class="text-xl">Error:</strong> <span class="text-lg ml-2">${error}</span>
            </div>
        `;
    }

    // Initialize tabs
    document.addEventListener('DOMContentLoaded', function() {
        // Set initial active tab
        const firstTabBtn = document.querySelector('.tab-btn');
        if (firstTabBtn) {
            firstTabBtn.classList.remove('bg-gray-100', 'text-gray-500');
            firstTabBtn.classList.add('bg-white', 'text-gray-800', '-translate-y-0.5', 'border-gray-200');
        }
        const firstTabContent = document.getElementById('single');
        if (firstTabContent) {
            firstTabContent.classList.remove('hidden');
            firstTabContent.classList.add('block');
        }
    });

    // Load sample data
    function loadSampleData() {
        document.getElementById('tenure').value = 12;
        document.getElementById('satisfaction').value = 3;
        document.getElementById('orders').value = 6;
        document.getElementById('appHours').value = 2.0;
        document.getElementById('daysSince').value = 8;
        document.getElementById('warehouse').value = 15;
        document.getElementById('complain').value = 0;
    }

    // Initialize charts function
    function initializeCharts(probabilityData, riskFactorsData, metricsData) {
        console.log('initializeCharts called with:', { probabilityData, riskFactorsData, metricsData });

        // Destroy existing charts if they exist
        const existingProbabilityChart = Chart.getChart('probabilityChart');
        if (existingProbabilityChart) {
            console.log('Destroying existing probability chart');
            existingProbabilityChart.destroy();
        }
        const existingRiskFactorsChart = Chart.getChart('riskFactorsChart');
        if (existingRiskFactorsChart) {
            console.log('Destroying existing risk factors chart');
            existingRiskFactorsChart.destroy();
        }
        const existingMetricsChart = Chart.getChart('metricsChart');
        if (existingMetricsChart) {
            console.log('Destroying existing metrics chart');
            existingMetricsChart.destroy();
        }

        try {
            // Check if canvas elements exist
            const probCanvas = document.getElementById('probabilityChart');
            const riskCanvas = document.getElementById('riskFactorsChart');
            const metricsCanvas = document.getElementById('metricsChart');

            console.log('Canvas elements found:', {
                probCanvas: !!probCanvas,
                riskCanvas: !!riskCanvas,
                metricsCanvas: !!metricsCanvas
            });

            if (!probCanvas || !riskCanvas || !metricsCanvas) {
                console.error('One or more canvas elements not found');
                return;
            }

            // Probability Chart (Pie Chart)
            console.log('Creating probability chart');
            new Chart(probCanvas, {
                type: 'pie',
                data: probabilityData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    }
                }
            });

            // Risk Factors Chart (Bar Chart)
            console.log('Creating risk factors chart');
            new Chart(riskCanvas, {
                type: 'bar',
                data: riskFactorsData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.y + '%';
                                }
                            }
                        }
                    }
                }
            });

            // Customer Metrics Chart (Line Chart)
            console.log('Creating metrics chart');
            new Chart(metricsCanvas, {
                type: 'line',
                data: metricsData,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 100,
                            ticks: {
                                callback: function(value) {
                                    return value + '%';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': ' + context.parsed.y + '%';
                                }
                            }
                        }
                    }
                }
            });

            console.log('All charts created successfully');
        } catch (error) {
            console.error('Error creating charts:', error);
        }
    }
</script>
{% endblock %}